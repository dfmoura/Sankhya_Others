SELECT DISTINCT
TO_CHAR(LAN.DTMOV,'YYYY') ANO,
TO_CHAR(LAN.DTMOV,'MM') MES,
TO_CHAR(LAN.DTMOV,'MM-YYYY') EXERCICIO,

SUM(CASE WHEN LAN.TIPLANC='R' THEN 1*LAN.VLRLANC WHEN LAN.TIPLANC='D' THEN -1*LAN.VLRLANC END)/1000 RESULTADO_LIQUIDO,

SUM(CASE WHEN LAN.TIPLANC='R' AND PLA.CODCTACTB IN (508,714) THEN 1*LAN.VLRLANC WHEN LAN.TIPLANC='D'AND PLA.CODCTACTB IN (508,714) THEN -1*LAN.VLRLANC END)/1000 RECEITA_BRUTO,
SUM(CASE WHEN LAN.TIPLANC='R' AND PLA.CODCTACTB IN (534,535,536,537,538,539,540,541,544,547) THEN 1*LAN.VLRLANC WHEN LAN.TIPLANC='D'AND PLA.CODCTACTB IN (534,535,536,537,538,539,540,541,544,547) THEN -1*LAN.VLRLANC END)/1000 DEDUCOES,



((SUM(CASE WHEN LAN.TIPLANC='R' AND PLA.CODCTACTB IN (508,714) THEN 1*LAN.VLRLANC WHEN LAN.TIPLANC='D'AND PLA.CODCTACTB IN (508,714) THEN -1*LAN.VLRLANC END))-
(SUM(CASE WHEN LAN.TIPLANC='R' AND PLA.CODCTACTB IN (534,535,536,537,538,539,540,541,544,547) THEN 1*LAN.VLRLANC WHEN LAN.TIPLANC='D'AND PLA.CODCTACTB IN (534,535,536,537,538,539,540,541,544,547) THEN -1*LAN.VLRLANC END)))/1000 REC_OPER_LIQ,

SUM(CASE WHEN LAN.TIPLANC='R' AND PLA.CODCTACTB IN (551) THEN 1*LAN.VLRLANC WHEN LAN.TIPLANC='D'AND PLA.CODCTACTB IN (551) THEN -1*LAN.VLRLANC END)/1000 CPV,
SUM(CASE WHEN LAN.TIPLANC='R' AND PLA.CODCTACTB IN (522,733,734,737,739) THEN 1*LAN.VLRLANC WHEN LAN.TIPLANC='D'AND PLA.CODCTACTB IN (522,733,734,737,739) THEN -1*LAN.VLRLANC END)/1000 OUTRAS_REC_OPER,
SUM(CASE WHEN LAN.TIPLANC='R' AND PLA.CODCTACTB IN (742,743,744,745,746,771,772,77) THEN 1*LAN.VLRLANC WHEN LAN.TIPLANC='D'AND PLA.CODCTACTB IN (742,743,744,745,746,771,772,778) THEN -1*LAN.VLRLANC END)/1000 OUTRAS_DES_OPER,



(
--receita liquida
((SUM(CASE WHEN LAN.TIPLANC='R' AND PLA.CODCTACTB IN (508,714) THEN 1*LAN.VLRLANC WHEN LAN.TIPLANC='D'AND PLA.CODCTACTB IN (508,714) THEN -1*LAN.VLRLANC END))- --RECEITA BRUTA
(SUM(CASE WHEN LAN.TIPLANC='R' AND PLA.CODCTACTB IN (534,535,536,537,538,539,540,541,544,547) THEN 1*LAN.VLRLANC WHEN LAN.TIPLANC='D'AND PLA.CODCTACTB IN (534,535,536,537,538,539,540,541,544,547) THEN -1*LAN.VLRLANC END))) --DEDUCOES
+
--cpv
(SUM(CASE WHEN LAN.TIPLANC='R' AND PLA.CODCTACTB IN (551) THEN 1*LAN.VLRLANC WHEN LAN.TIPLANC='D'AND PLA.CODCTACTB IN (551) THEN -1*LAN.VLRLANC END))
+
--custo de producao
(SUM(CASE 
WHEN LAN.TIPLANC='R' AND PLA.CODCTACTB IN (360,361,362,363,364,365,366,367,368,369,292,371,372,373,374,377,378,380,381,382,383,384,386,387,389,390,391,392,393,394,395,397,398,399,400,799,806,809,408,409,411,350,413,414,415,416,807,417,418,419,420,421,422,423,424,425,426,427,428,429,789,432,433,435,436,437,438,440,441,442,444,445,446,447,448,351,450,451,452,454,456,457,458,460,461,462,463,464,790,800,465,352,467,355,469,470,471,472,473,412,476,449,479,480,481,482,793,483,484,485,486,487,488,489,490,491,492,493,494) THEN 1*LAN.VLRLANC 
WHEN LAN.TIPLANC='D' AND PLA.CODCTACTB IN (360,361,362,363,364,365,366,367,368,369,292,371,372,373,374,377,378,380,381,382,383,384,386,387,389,390,391,392,393,394,395,397,398,399,400,799,806,809,408,409,411,350,413,414,415,416,807,417,418,419,420,421,422,423,424,425,426,427,428,429,789,432,433,435,436,437,438,440,441,442,444,445,446,447,448,351,450,451,452,454,456,457,458,460,461,462,463,464,790,800,465,352,467,355,469,470,471,472,473,412,476,449,479,480,481,482,793,483,484,485,486,487,488,489,490,491,492,493,494) THEN -1*LAN.VLRLANC 
END))
)/1000 
RESULTADO_BRUTO, 




(((


(CASE WHEN TO_CHAR(LAN.DTMOV,'MM-YYYY') = TO_CHAR(SYSDATE,'MM-YYYY') 
THEN 
--CUSTO FIXO PARCIAL
(((LAG(
SUM(CASE 
WHEN (PLA.CODCTACTB NOT IN (458, 508, 714, 522, 534, 536, 537, 539, 541, 544, 545, 546, 551,599, 601, 603, 715, 716, 718, 721,757,758,759))
AND LAN.TIPLANC='R' THEN 1*LAN.VLRLANC
WHEN (PLA.CODCTACTB NOT IN (458, 508, 714, 522, 534, 536, 537, 539, 541, 544, 545, 546, 551,599, 601, 603, 715, 716, 718, 721,757,758,759))
AND LAN.TIPLANC='D' THEN -1*LAN.VLRLANC 
END),1) OVER (ORDER BY TO_CHAR(LAN.DTMOV,'YYYY') ASC, TO_CHAR(LAN.DTMOV,'MM') ASC)*-1)+
(LAG(
SUM(CASE 
WHEN (PLA.CODCTACTB NOT IN (458, 508, 714, 522, 534, 536, 537, 539, 541, 544, 545, 546, 551,599, 601, 603, 715, 716, 718, 721,757,758,759,811,812))
AND LAN.TIPLANC='R' THEN 1*LAN.VLRLANC
WHEN (PLA.CODCTACTB NOT IN (458, 508, 714, 522, 534, 536, 537, 539, 541, 544, 545, 546, 551,599, 601, 603, 715, 716, 718, 721,757,758,759,811,812))
AND LAN.TIPLANC='D' THEN -1*LAN.VLRLANC 
END),2) OVER (ORDER BY TO_CHAR(LAN.DTMOV,'YYYY') ASC, TO_CHAR(LAN.DTMOV,'MM') ASC)*-1)+
(LAG(
SUM(CASE 
WHEN (PLA.CODCTACTB NOT IN (458, 508, 714, 522, 534, 536, 537, 539, 541, 544, 545, 546, 551,599, 601, 603, 715, 716, 718, 721,757,758,759))
AND LAN.TIPLANC='R' THEN 1*LAN.VLRLANC
WHEN (PLA.CODCTACTB NOT IN (458, 508, 714, 522, 534, 536, 537, 539, 541, 544, 545, 546, 551,599, 601, 603, 715, 716, 718, 721,757,758,759))
AND LAN.TIPLANC='D' THEN -1*LAN.VLRLANC 
END),3) OVER (ORDER BY TO_CHAR(LAN.DTMOV,'YYYY') ASC, TO_CHAR(LAN.DTMOV,'MM') ASC)*-1))/3*-1) 


ELSE
--CUSTO FIXO FECHADO
SUM(CASE 
WHEN (PLA.CODCTACTB NOT IN (458, 508, 714, 522, 534, 536, 537, 539, 541, 544, 545, 546, 551,599, 601, 603, 715, 716, 718, 721,757,758,759))
AND LAN.TIPLANC='R' THEN 1*LAN.VLRLANC
WHEN (PLA.CODCTACTB NOT IN (458, 508, 714, 522, 534, 536, 537, 539, 541, 544, 545, 546, 551,599, 601, 603, 715, 716, 718, 721,757,758,759))
AND LAN.TIPLANC='D' THEN -1*LAN.VLRLANC 
END)


END)

/

(SUM((CASE WHEN LAN.TIPLANC='R' AND PLA.CODCTACTB IN (508,714) THEN 1*LAN.VLRLANC WHEN LAN.TIPLANC='D'AND PLA.CODCTACTB IN (508,714) THEN -1*LAN.VLRLANC END))))*-1)*100) CUSTO_PART_PERC,




(CASE WHEN TO_CHAR(LAN.DTMOV,'MM-YYYY') = TO_CHAR(SYSDATE,'MM-YYYY') 
THEN 'PARCIAL' ELSE 'FECHADO' END) T,

(CASE WHEN TO_CHAR(LAN.DTMOV,'MM-YYYY') = TO_CHAR(SYSDATE,'MM-YYYY') 
THEN 
--CUSTO FIXO PARCIAL
(((LAG(
SUM(CASE 
WHEN (PLA.CODCTACTB NOT IN (458, 508, 714, 522, 534, 536, 537, 539, 541, 544, 545, 546, 551,599, 601, 603, 715, 716, 718, 721,757,758,759,811,812))
AND LAN.TIPLANC='R' THEN 1*LAN.VLRLANC
WHEN (PLA.CODCTACTB NOT IN (458, 508, 714, 522, 534, 536, 537, 539, 541, 544, 545, 546, 551,599, 601, 603, 715, 716, 718, 721,757,758,759,811,812))
AND LAN.TIPLANC='D' THEN -1*LAN.VLRLANC 
END),1) OVER (ORDER BY TO_CHAR(LAN.DTMOV,'YYYY') ASC, TO_CHAR(LAN.DTMOV,'MM') ASC)*-1)+
(LAG(
SUM(CASE 
WHEN (PLA.CODCTACTB NOT IN (458, 508, 714, 522, 534, 536, 537, 539, 541, 544, 545, 546, 551,599, 601, 603, 715, 716, 718, 721,757,758,759,811,812))
AND LAN.TIPLANC='R' THEN 1*LAN.VLRLANC
WHEN (PLA.CODCTACTB NOT IN (458, 508, 714, 522, 534, 536, 537, 539, 541, 544, 545, 546, 551,599, 601, 603, 715, 716, 718, 721,757,758,759,811,812))
AND LAN.TIPLANC='D' THEN -1*LAN.VLRLANC 
END),2) OVER (ORDER BY TO_CHAR(LAN.DTMOV,'YYYY') ASC, TO_CHAR(LAN.DTMOV,'MM') ASC)*-1)+
(LAG(
SUM(CASE 
WHEN (PLA.CODCTACTB NOT IN (458, 508, 714, 522, 534, 536, 537, 539, 541, 544, 545, 546, 551,599, 601, 603, 715, 716, 718, 721,757,758,759))
AND LAN.TIPLANC='R' THEN 1*LAN.VLRLANC
WHEN (PLA.CODCTACTB NOT IN (458, 508, 714, 522, 534, 536, 537, 539, 541, 544, 545, 546, 551,599, 601, 603, 715, 716, 718, 721,757,758,759))
AND LAN.TIPLANC='D' THEN -1*LAN.VLRLANC 
END),3) OVER (ORDER BY TO_CHAR(LAN.DTMOV,'YYYY') ASC, TO_CHAR(LAN.DTMOV,'MM') ASC)*-1))/3*-1) 
ELSE
--CUSTO FIXO FECHADO
SUM(CASE 
WHEN (PLA.CODCTACTB NOT IN (458, 508, 714, 522, 534, 536, 537, 539, 541, 544, 545, 546, 551,599, 601, 603, 715, 716, 718, 721,757,758,759,811,812))
AND LAN.TIPLANC='R' THEN 1*LAN.VLRLANC
WHEN (PLA.CODCTACTB NOT IN (458, 508, 714, 522, 534, 536, 537, 539, 541, 544, 545, 546, 551,599, 601, 603, 715, 716, 718, 721,757,758,759,811,812))
AND LAN.TIPLANC='D' THEN -1*LAN.VLRLANC 
END)
END)/1000 CUSTO_FIXO,




((((((SUM(CASE WHEN LAN.TIPLANC='R' AND PLA.CODCTACTB IN (508,714) THEN 1*LAN.VLRLANC WHEN LAN.TIPLANC='D'AND PLA.CODCTACTB IN (508,714) THEN -1*LAN.VLRLANC END))+
(SUM(CASE WHEN LAN.TIPLANC='R' AND PLA.CODCTACTB IN (534,535,536,537,538,539,540,541,544,547) THEN 1*LAN.VLRLANC WHEN LAN.TIPLANC='D'AND PLA.CODCTACTB IN (534,535,536,537,538,539,540,541,544,547) THEN -1*LAN.VLRLANC END)))+
(SUM(CASE WHEN LAN.TIPLANC='R' AND PLA.CODCTACTB IN (551) THEN 1*LAN.VLRLANC WHEN LAN.TIPLANC='D'AND PLA.CODCTACTB IN (551) THEN -1*LAN.VLRLANC END)))) /
(SUM(CASE WHEN LAN.TIPLANC='R' AND PLA.CODCTACTB IN (508,714) THEN 1*LAN.VLRLANC WHEN LAN.TIPLANC='D'AND PLA.CODCTACTB IN (508,714) THEN -1*LAN.VLRLANC END)))*100) MARGEM_BRUTA,


(((SUM(CASE WHEN LAN.TIPLANC='R' THEN 1*LAN.VLRLANC WHEN LAN.TIPLANC='D' THEN -1*LAN.VLRLANC END))/
(SUM(CASE WHEN LAN.TIPLANC='R' AND PLA.CODCTACTB IN (508,714) THEN 1*LAN.VLRLANC WHEN LAN.TIPLANC='D'AND PLA.CODCTACTB IN (508,714) THEN -1*LAN.VLRLANC END)))*100) MARGEM_LIQ,

(((SUM(CASE 
WHEN LAN.TIPLANC='R' AND PLA.CODCTACTB IN (700,702,705,710,711,716,724,725,726,728,757,758,759) THEN 1*LAN.VLRLANC 
WHEN LAN.TIPLANC='D' AND PLA.CODCTACTB IN (700,702,705,710,711,716,724,725,726,728,757,758,759) THEN -1*LAN.VLRLANC END)*-1)) +
(SUM(CASE WHEN LAN.TIPLANC='R' THEN 1*LAN.VLRLANC WHEN LAN.TIPLANC='D' THEN -1*LAN.VLRLANC END)))/1000 EBIT,

((SUM(CASE 
WHEN LAN.TIPLANC='R' AND PLA.CODCTACTB IN (700,702,705,710,711,716,724,725,726,728,757,758,759,415,472,482,655) THEN 1*LAN.VLRLANC 
WHEN LAN.TIPLANC='D' AND PLA.CODCTACTB IN (700,702,705,710,711,716,724,725,726,728,757,758,759,415,472,482,655) THEN -1*LAN.VLRLANC END)*-1) + 
(SUM(CASE WHEN LAN.TIPLANC='R' THEN 1*LAN.VLRLANC WHEN LAN.TIPLANC='D' THEN -1*LAN.VLRLANC END)))/1000 EBITDA,

SUM(CASE 
WHEN LAN.TIPLANC='R' AND PLA.CODCTACTB IN (556,557,558,559,560,561,562,563,564,466,566,567,569,571,573,574,575,577,578,579,580,581,582,584,585,586,588,589,590,591,592,593,594,595,596,597,598,599,600,601,603,604,605,606,607,609,610,612,613,783,791,802,803,614,615,616,617,618,619,620,621,623,624,625,626,627,628,629,630,633,634,635,636,637,638,640,641,642,643,644,645,646,647,788,649,651,652,653,654,655,656,657,658,660,661,662,663,664,665,666,667,668,669,670,671,787,673,674,675,676,677,678,679,680,801,808,682,683,684,685,686,687,688,689,690,691,692,693,694,695,696,697,698,699,701,704,706,707,708,709,710,712,713,804,805,715,718,719,721,722,723,727) THEN 1*LAN.VLRLANC 
WHEN LAN.TIPLANC='D' AND PLA.CODCTACTB IN (556,557,558,559,560,561,562,563,564,466,566,567,569,571,573,574,575,577,578,579,580,581,582,584,585,586,588,589,590,591,592,593,594,595,596,597,598,599,600,601,603,604,605,606,607,609,610,612,613,783,791,802,803,614,615,616,617,618,619,620,621,623,624,625,626,627,628,629,630,633,634,635,636,637,638,640,641,642,643,644,645,646,647,788,649,651,652,653,654,655,656,657,658,660,661,662,663,664,665,666,667,668,669,670,671,787,673,674,675,676,677,678,679,680,801,808,682,683,684,685,686,687,688,689,690,691,692,693,694,695,696,697,698,699,701,704,706,707,708,709,710,712,713,804,805,715,718,719,721,722,723,727) THEN -1*LAN.VLRLANC 
END)/1000 DESP_OPER,

SUM(CASE 
WHEN LAN.TIPLANC='R' AND PLA.CODCTACTB IN (360,361,362,363,364,365,366,367,368,369,292,371,372,373,374,377,378,380,381,382,383,384,386,387,389,390,391,392,393,394,395,397,398,399,400,799,806,809,408,409,411,350,413,414,415,416,807,417,418,419,420,421,422,423,424,425,426,427,428,429,789,432,433,435,436,437,438,440,441,442,444,445,446,447,448,351,450,451,452,454,456,457,458,460,461,462,463,464,790,800,465,352,467,355,469,470,471,472,473,412,476,449,479,480,481,482,793,483,484,485,486,487,488,489,490,491,492,493,494) THEN 1*LAN.VLRLANC 
WHEN LAN.TIPLANC='D' AND PLA.CODCTACTB IN (360,361,362,363,364,365,366,367,368,369,292,371,372,373,374,377,378,380,381,382,383,384,386,387,389,390,391,392,393,394,395,397,398,399,400,799,806,809,408,409,411,350,413,414,415,416,807,417,418,419,420,421,422,423,424,425,426,427,428,429,789,432,433,435,436,437,438,440,441,442,444,445,446,447,448,351,450,451,452,454,456,457,458,460,461,462,463,464,790,800,465,352,467,355,469,470,471,472,473,412,476,449,479,480,481,482,793,483,484,485,486,487,488,489,490,491,492,493,494) THEN -1*LAN.VLRLANC 
END)/1000 CUSTO_PRODUCAO




FROM TCBLAN LAN
INNER JOIN TCBPLA PLA ON LAN.CODCTACTB = PLA.CODCTACTB
WHERE 
LAN.CODEMP = :P_EMPRESA
AND (LAN.DTMOV >= :P_PERIODO.INI AND LAN.DTMOV <= :P_PERIODO.FIN)
AND LPAD(PLA.CTACTB,1) IN (3,5)
AND PLA.ANALITICA = 'S'
AND LAN.NUMLOTE NOT IN (9999)

GROUP BY
TO_CHAR(LAN.DTMOV,'YYYY'),
TO_CHAR(LAN.DTMOV,'MM'),
TO_CHAR(LAN.DTMOV,'MM-YYYY')

ORDER BY
1,2


