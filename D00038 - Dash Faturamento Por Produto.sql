--RELATORIO DE FATURAMENTO - INTERVALO DE DATAS POR DTNEG

SELECT DISTINCT
CAB.CODTIPOPER TOPS,
TOP.DESCROPER DESCRTOP,
(CASE
WHEN (UFS.UF = 'MG') THEN TOP.CODCFO_SAIDA
WHEN (UFS.UF  'MG') THEN TOP.CODCFO_SAIDA_FORA
END) AS CFOP,
UFS.UF,
CAB.NUNOTA,
CAB.NUMNOTA,
ITE.SEQUENCIA,
CAB.DTFATUR,
CAB.DTENTSAI,
CAB.DTMOV DTMOV,
CAB.DTNEG,
CAB.CODEMP,
EMP.RAZAOSOCIAL EMPRESA,
CAB.CODPARC,
PAR.CGC_CPF,
PAR.RAZAOSOCIAL PARCEIRO,
CAB.TIPMOV,
ITE.CODPROD,
PRO.DESCRPROD,
GRU.DESCRGRUPOPROD,
PRO.USOPROD,
ITE.CODTRIB,
PRO.NCM,
PRO.CODVOL,
(CASE
WHEN CAB.CODTIPOPER IN (1200,1201,1216,1217) THEN ITE.QTDNEG  -1
WHEN CAB.CODTIPOPER IN (1100,1112,1152,1105,1153) THEN ITE.QTDNEG END) AS QTDNEG,
TTLQTDE,
ITE.VLRUNIT,


(CASE
WHEN CAB.CODTIPOPER IN (1200,1201,1216,1217) THEN ITE.VLRTOT  -1
WHEN CAB.CODTIPOPER IN (1100,1112,1152,1105,1153) THEN ITE.VLRTOT END) AS VLRTOT,


(CASE WHEN (TTLQTDE = 0) THEN 0 ELSE (
((CASE
WHEN CAB.CODTIPOPER IN (1200,1201,1216,1217) THEN ITE.QTDNEG  -1
WHEN CAB.CODTIPOPER IN (1100,1112,1152,1105,1153) THEN ITE.QTDNEG END)TTLQTDE) )END) AS PART_PERC_QTD_NO_PROD,

(CASE WHEN (TTLQTDE = 0) THEN 0 ELSE (
(((CASE
WHEN CAB.CODTIPOPER IN (1200,1201,1216,1217) THEN ITE.QTDNEG  -1
WHEN CAB.CODTIPOPER IN (1100,1112,1152,1105,1153) THEN ITE.QTDNEG END) TTLQTDE)  CAB.VLRNOTA) )END) AS VLR_PROP_PROD,

CAB.VLRFRETE,

CAB.ISSRETIDO,

(CAB.VLRISS  
(CASE WHEN (TTLQTDE = 0) THEN 0 ELSE (
((CASE
WHEN CAB.CODTIPOPER IN (1200,1201,1216,1217) THEN ITE.QTDNEG  -1
WHEN CAB.CODTIPOPER IN (1100,1112,1152,1105,1153) THEN ITE.QTDNEG END)TTLQTDE) )END)) AS VLRISS,

CASE WHEN CAB.ISSRETIDO = 'S' THEN 
(CAB.VLRISS  
(CASE WHEN (TTLQTDE = 0) THEN 0 ELSE (
((CASE
WHEN CAB.CODTIPOPER IN (1200,1201,1216,1217) THEN ITE.QTDNEG  -1
WHEN CAB.CODTIPOPER IN (1100,1112,1152,1105,1153) THEN ITE.QTDNEG END)TTLQTDE) )END))+
(CASE WHEN (TTLQTDE = 0) THEN 0 ELSE (
(((CASE
WHEN CAB.CODTIPOPER IN (1200,1201,1216,1217) THEN ITE.QTDNEG  -1
WHEN CAB.CODTIPOPER IN (1100,1112,1152,1105,1153) THEN ITE.QTDNEG END) TTLQTDE)  CAB.VLRNOTA) )END) ELSE 0 END TESTE

FROM TGFCAB CAB
INNER JOIN TGFITE ITE ON CAB.NUNOTA = ITE.NUNOTA
INNER JOIN TSIEMP EMP ON CAB.CODEMP = EMP.CODEMP
INNER JOIN TGFPAR PAR ON CAB.CODPARC = PAR.CODPARC
INNER JOIN TGFTOP TOP ON CAB.CODTIPOPER = TOP.CODTIPOPER
INNER JOIN TGFPRO PRO ON ITE.CODPROD = PRO.CODPROD
INNER JOIN TGFGRU GRU ON PRO.CODGRUPOPROD = GRU.CODGRUPOPROD
INNER JOIN TSICID CID ON PAR.CODCID = CID.CODCID
INNER JOIN TSIUFS UFS ON CID.UF = UFS.CODUF
INNER JOIN (SELECT ITE.NUNOTA, SUM(QTDNEG) AS TTLQTDE
FROM TGFITE ITE GROUP BY ITE.NUNOTA) ITE2 ON ITE.NUNOTA = ITE2.NUNOTA
WHERE (CAB.DTNEG = P_PERIODO.INI AND CAB.DTNEG = P_PERIODO.FIN)
AND CAB.CODEMP IN P_EMPRESA
AND CAB.CODTIPOPER  IN (1100,1112,1152,1200,1201,1216,1217,1105,1153)
AND CAB.STATUSNOTA = 'L'
ORDER BY 8,5,7
