--RELATORIO DE FATURAMENTO - INTERVALO DE DATAS POR DTNEG

SELECT DISTINCT

SUM(CASE WHEN GRU.DESCRGRUPOPROD = 'COMPOSTO ORGANICO' THEN
((CASE WHEN (TTLQTDE = 0) THEN 0 ELSE (
(((CASE
WHEN CAB.CODTIPOPER IN (1200,1201,1215,1216,1217) THEN ITE.QTDNEG * -1
WHEN CAB.CODTIPOPER IN (1100,1112,1152,1105,1153) THEN ITE.QTDNEG END) /TTLQTDE) * CAB.VLRNOTA) )END)) 
ELSE 0 END) AS COMP_ORGAN,

SUM(CASE WHEN GRU.DESCRGRUPOPROD = 'SERVICOS PRESTADOS' THEN
((CASE WHEN (TTLQTDE = 0) THEN 0 ELSE (
(((CASE
WHEN CAB.CODTIPOPER IN (1200,1201,1215,1216,1217) THEN ITE.QTDNEG * -1
WHEN CAB.CODTIPOPER IN (1100,1112,1152,1105,1153) THEN ITE.QTDNEG END) /TTLQTDE) * CAB.VLRNOTA) )END)) 
ELSE 0 END) AS SERV_PREST,

SUM(CASE WHEN GRU.DESCRGRUPOPROD = 'FERTILIZANTES' THEN
((CASE WHEN (TTLQTDE = 0) THEN 0 ELSE (
(((CASE
WHEN CAB.CODTIPOPER IN (1200,1201,1215,1216,1217) THEN ITE.QTDNEG * -1
WHEN CAB.CODTIPOPER IN (1100,1112,1152,1105,1153) THEN ITE.QTDNEG END) /TTLQTDE) * CAB.VLRNOTA) )END)) 
ELSE 0 END) AS FERT,

SUM(CASE WHEN GRU.DESCRGRUPOPROD = 'SERVICO DESTINACAO RESIDUO' THEN
((CASE WHEN (TTLQTDE = 0) THEN 0 ELSE (
(((CASE
WHEN CAB.CODTIPOPER IN (1200,1201,1215,1216,1217) THEN ITE.QTDNEG * -1
WHEN CAB.CODTIPOPER IN (1100,1112,1152,1105,1153) THEN ITE.QTDNEG END) /TTLQTDE) * CAB.VLRNOTA) )END)) 
ELSE 0 END) AS SERV_DEST_RES

FROM TGFCAB CAB
INNER JOIN TGFITE ITE ON CAB.NUNOTA = ITE.NUNOTA
INNER JOIN TGFPRO PRO ON ITE.CODPROD = PRO.CODPROD
INNER JOIN TGFGRU GRU ON PRO.CODGRUPOPROD = GRU.CODGRUPOPROD
INNER JOIN (SELECT ITE.NUNOTA, SUM(QTDNEG) AS TTLQTDE
FROM TGFITE ITE GROUP BY ITE.NUNOTA) ITE2 ON ITE.NUNOTA = ITE2.NUNOTA
INNER JOIN TGFVEN VEN ON CAB.CODVEND = VEN.CODVEND
WHERE 
TO_CHAR(CAB.DTNEG, 'YYYY-MM') = TO_CHAR(ADD_MONTHS(SYSDATE, 0), 'YYYY-MM')
AND CAB.CODEMP =60
AND CAB.CODTIPOPER  IN (1100,1112,1152,1200,1201,1215,1216,1217,1105,1153)
AND CAB.STATUSNOTA = 'L'