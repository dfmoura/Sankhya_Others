--RELATORIO DE FATURAMENTO - INTERVALO DE DATAS POR DTNEG

WITH T AS (
SELECT DISTINCT
CAB.CODTIPOPER TOPS,
TOP.DESCROPER DESCRTOP,
(CASE
WHEN (UFS.UF = 'MG') THEN TOP.CODCFO_SAIDA
WHEN (UFS.UF <> 'MG') THEN TOP.CODCFO_SAIDA_FORA
END) AS "CFOP",
UFS.UF,
CAB.NUNOTA,
CAB.NUMNOTA,
ITE.SEQUENCIA,
CAB.DTFATUR,
CAB.DTENTSAI,
CAB.DTMOV DTMOV,
CAB.DTNEG,
CAB.CODEMP,
EMP.RAZAOSOCIAL "EMPRESA",
CAB.CODPARC,
PAR.CGC_CPF,
PAR.RAZAOSOCIAL "PARCEIRO",
CAB.TIPMOV,
ITE.CODPROD,
PRO.DESCRPROD,
PRO.CODGRUPOPROD,
GRU.DESCRGRUPOPROD,
PRO.USOPROD,
ITE.CODTRIB,
PRO.NCM,
PRO.CODVOL,
VEN.APELIDO,
(CASE
WHEN CAB.CODTIPOPER IN (1200,1201,1215,1216,1217) THEN ITE.QTDNEG * -1
WHEN CAB.CODTIPOPER IN (1100,1112,1152,1105,1153) THEN ITE.QTDNEG END) AS QTDNEG,
TTLQTDE,
ITE.VLRUNIT,
(CASE
WHEN CAB.CODTIPOPER IN (1200,1201,1215,1216,1217) THEN ITE.VLRTOT * -1
WHEN CAB.CODTIPOPER IN (1100,1112,1152,1105,1153) THEN ITE.VLRTOT END) AS VLRTOT,
(CASE WHEN (TTLQTDE = 0) THEN 0 ELSE (
((CASE
WHEN CAB.CODTIPOPER IN (1200,1201,1215,1216,1217) THEN ITE.QTDNEG * -1
WHEN CAB.CODTIPOPER IN (1100,1112,1152,1105,1153) THEN ITE.QTDNEG END)/TTLQTDE) )END) AS PART_PERC_QTD_NO_PROD,
(CASE WHEN (TTLQTDE = 0) THEN 0 ELSE (
(((CASE
WHEN CAB.CODTIPOPER IN (1200,1201,1215,1216,1217) THEN ITE.QTDNEG * -1
WHEN CAB.CODTIPOPER IN (1100,1112,1152,1105,1153) THEN ITE.QTDNEG END) /TTLQTDE) * CAB.VLRNOTA) )END) AS VLR_PROP_PROD,
CAB.VLRFRETE,
CAB.ISSRETIDO,
(CAB.VLRISS * 
(CASE WHEN (TTLQTDE = 0) THEN 0 ELSE (
((CASE
WHEN CAB.CODTIPOPER IN (1200,1201,1215,1216,1217) THEN ITE.QTDNEG * -1
WHEN CAB.CODTIPOPER IN (1100,1112,1152,1105,1153) THEN ITE.QTDNEG END)/TTLQTDE) )END)) AS VLRISS,
CASE WHEN CAB.ISSRETIDO = 'S' THEN 
(CAB.VLRISS * 
(CASE WHEN (TTLQTDE = 0) THEN 0 ELSE (
((CASE
WHEN CAB.CODTIPOPER IN (1200,1201,1215,1216,1217) THEN ITE.QTDNEG * -1
WHEN CAB.CODTIPOPER IN (1100,1112,1152,1105,1153) THEN ITE.QTDNEG END)/TTLQTDE) )END))+
(CASE WHEN (TTLQTDE = 0) THEN 0 ELSE (
(((CASE
WHEN CAB.CODTIPOPER IN (1200,1201,1215,1216,1217) THEN ITE.QTDNEG * -1
WHEN CAB.CODTIPOPER IN (1100,1112,1152,1105,1153) THEN ITE.QTDNEG END) /TTLQTDE) * CAB.VLRNOTA) )END) 
ELSE 
(CASE WHEN (TTLQTDE = 0) THEN 0 ELSE (
(((CASE
WHEN CAB.CODTIPOPER IN (1200,1201,1215,1216,1217) THEN ITE.QTDNEG * -1
WHEN CAB.CODTIPOPER IN (1100,1112,1152,1105,1153) THEN ITE.QTDNEG END) /TTLQTDE) * CAB.VLRNOTA) )END) 
END VLR_PROP_PROD_COM_ISS
FROM TGFCAB CAB
INNER JOIN TGFITE ITE ON CAB.NUNOTA = ITE.NUNOTA
INNER JOIN TSIEMP EMP ON CAB.CODEMP = EMP.CODEMP
INNER JOIN TGFPAR PAR ON CAB.CODPARC = PAR.CODPARC
INNER JOIN TGFTOP TOP ON CAB.CODTIPOPER = TOP.CODTIPOPER
INNER JOIN TGFPRO PRO ON ITE.CODPROD = PRO.CODPROD
INNER JOIN TGFGRU GRU ON PRO.CODGRUPOPROD = GRU.CODGRUPOPROD
INNER JOIN TSICID CID ON PAR.CODCID = CID.CODCID
INNER JOIN TSIUFS UFS ON CID.UF = UFS.CODUF
INNER JOIN (SELECT ITE.NUNOTA, SUM(QTDNEG) AS TTLQTDE
FROM TGFITE ITE GROUP BY ITE.NUNOTA) ITE2 ON ITE.NUNOTA = ITE2.NUNOTA
INNER JOIN TGFVEN VEN ON CAB.CODVEND = VEN.CODVEND
WHERE
TO_CHAR(CAB.DTNEG, 'YYYY') = TO_CHAR(SYSDATE, 'YYYY')
AND CAB.CODTIPOPER  IN (1100,1112,1152,1200,1201,1215,1216,1217,1105,1153)
AND CAB.STATUSNOTA = 'L')
SELECT 
SUM(VLR_PROP_PROD_COM_ISS) FAT, 
SUM (
CASE 
wHEN T.CODGRUPOPROD  = 1040000 THEN QTDNEG ELSE 0 END) AS MINERAIS,
SUM (
CASE 
wHEN T.CODGRUPOPROD  = 2040000 THEN QTDNEG ELSE 0 END) AS COMP_ORGAN,
SUM (
CASE 
wHEN T.CODGRUPOPROD  = 2030000 THEN QTDNEG ELSE 0 END) AS FERT
FROM T